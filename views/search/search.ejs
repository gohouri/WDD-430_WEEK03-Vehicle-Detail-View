<%- include('../partials/header') %>

<div class="container">
    <h1>Search Vehicles</h1>
    <p>Find your perfect vehicle using our advanced search and filter options.</p>
    
    <!-- Flash Messages -->
    <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-<%= messageType || 'info' %>">
            <%= message %>
        </div>
    <% } %>

    <div class="search-container">
        <form method="GET" action="/search/results" class="search-form">
            <!-- Search Query -->
            <div class="form-group">
                <label for="q">Search Term</label>
                <input type="text" 
                       id="q" 
                       name="q" 
                       value="<%= searchParams.query || '' %>" 
                       placeholder="Search by make, model, year, or description..."
                       class="form-control search-input"
                       autocomplete="off">
                <div id="search-suggestions" class="search-suggestions"></div>
            </div>

            <!-- Filters Row 1 -->
            <div class="filters-row">
                <div class="form-group">
                    <label for="classification_id">Vehicle Type</label>
                    <select id="classification_id" name="classification_id" class="form-control">
                        <option value="all" <%= searchParams.classification_id === 'all' ? 'selected' : '' %>>All Types</option>
                        <% classifications.forEach(classification => { %>
                            <option value="<%= classification.classification_id %>" 
                                    <%= searchParams.classification_id == classification.classification_id ? 'selected' : '' %>>
                                <%= classification.classification_name %>
                            </option>
                        <% }); %>
                    </select>
                </div>

                <div class="form-group">
                    <label for="color">Color</label>
                    <select id="color" name="color" class="form-control">
                        <option value="all" <%= searchParams.color === 'all' ? 'selected' : '' %>>All Colors</option>
                        <% colors.forEach(color => { %>
                            <option value="<%= color %>" <%= searchParams.color === color ? 'selected' : '' %>>
                                <%= color %>
                            </option>
                        <% }); %>
                    </select>
                </div>
            </div>

            <!-- Filters Row 2 - Price Range -->
            <div class="filters-row">
                <div class="form-group">
                    <label for="min_price">Min Price</label>
                    <input type="number" 
                           id="min_price" 
                           name="min_price" 
                           value="<%= searchParams.min_price || '' %>" 
                           placeholder="Min Price"
                           min="0"
                           step="1000"
                           class="form-control">
                </div>

                <div class="form-group">
                    <label for="max_price">Max Price</label>
                    <input type="number" 
                           id="max_price" 
                           name="max_price" 
                           value="<%= searchParams.max_price || '' %>" 
                           placeholder="Max Price"
                           min="0"
                           step="1000"
                           class="form-control">
                </div>
            </div>

            <!-- Filters Row 3 - Mileage Range -->
            <div class="filters-row">
                <div class="form-group">
                    <label for="min_miles">Min Mileage</label>
                    <input type="number" 
                           id="min_miles" 
                           name="min_miles" 
                           value="<%= searchParams.min_miles || '' %>" 
                           placeholder="Min Miles"
                           min="0"
                           step="1000"
                           class="form-control">
                </div>

                <div class="form-group">
                    <label for="max_miles">Max Mileage</label>
                    <input type="number" 
                           id="max_miles" 
                           name="max_miles" 
                           value="<%= searchParams.max_miles || '' %>" 
                           placeholder="Max Miles"
                           min="0"
                           step="1000"
                           class="form-control">
                </div>
            </div>

            <!-- Filters Row 4 - Year Range -->
            <div class="filters-row">
                <div class="form-group">
                    <label for="min_year">Min Year</label>
                    <input type="number" 
                           id="min_year" 
                           name="min_year" 
                           value="<%= searchParams.min_year || '' %>" 
                           placeholder="Min Year"
                           min="<%= yearRange.min_year %>"
                           max="<%= yearRange.max_year %>"
                           class="form-control">
                </div>

                <div class="form-group">
                    <label for="max_year">Max Year</label>
                    <input type="number" 
                           id="max_year" 
                           name="max_year" 
                           value="<%= searchParams.max_year || '' %>" 
                           placeholder="Max Year"
                           min="<%= yearRange.min_year %>"
                           max="<%= yearRange.max_year %>"
                           class="form-control">
                </div>
            </div>

            <!-- Search Buttons -->
            <div class="search-buttons">
                <button type="submit" class="btn btn-primary btn-search">
                    <i class="search-icon">üîç</i> Search Vehicles
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">
                    <i class="clear-icon">üóëÔ∏è</i> Clear Filters
                </button>
            </div>
        </form>

        <!-- Quick Search Options -->
        <div class="quick-search">
            <h3>Quick Search</h3>
            <div class="quick-search-buttons">
                <a href="/search/results?classification_id=1" class="btn btn-outline">SUVs</a>
                <a href="/search/results?classification_id=2" class="btn btn-outline">Sedans</a>
                <a href="/search/results?classification_id=3" class="btn btn-outline">Trucks</a>
                <a href="/search/results?classification_id=4" class="btn btn-outline">Coupes</a>
                <a href="/search/results?max_price=20000" class="btn btn-outline">Under $20K</a>
                <a href="/search/results?max_miles=50000" class="btn btn-outline">Low Mileage</a>
            </div>
        </div>
    </div>
</div>

<script>
// Search suggestions functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('q');
    const suggestionsDiv = document.getElementById('search-suggestions');
    let suggestionsTimeout;

    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(suggestionsTimeout);
        
        if (query.length < 2) {
            suggestionsDiv.innerHTML = '';
            suggestionsDiv.style.display = 'none';
            return;
        }

        // Debounce the request
        suggestionsTimeout = setTimeout(() => {
            fetch(`/search/suggestions?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(suggestions => {
                    if (suggestions.length > 0) {
                        suggestionsDiv.innerHTML = suggestions.map(suggestion => 
                            `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
                        ).join('');
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching suggestions:', error);
                    suggestionsDiv.style.display = 'none';
                });
        }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });
});

function selectSuggestion(suggestion) {
    document.getElementById('q').value = suggestion;
    document.getElementById('search-suggestions').style.display = 'none';
}

function clearForm() {
    document.querySelector('.search-form').reset();
    document.getElementById('search-suggestions').style.display = 'none';
}
</script>

<%- include('../partials/footer') %>
